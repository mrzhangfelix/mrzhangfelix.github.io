## Zookeeper是什么

zookeeper，它是一个分布式服务框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。

上面的解释有点抽象，简单来说zookeeper=文件系统+监听通知机制。

有四种类型的znode：

- **PERSISTENT-持久化目录节点**

  客户端与zookeeper断开连接后，该节点依旧存在

- **PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点**

  客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号

- **EPHEMERAL-临时目录节点**

  客户端与zookeeper断开连接后，该节点被删除

- **EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点**

  客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号

**监听通知机制**

客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端。

就这么简单，下面我们看看Zookeeper能做点什么呢？

# **Zookeeper能做什么**

zookeeper功能非常强大，可以实现诸如分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能，我们这里拿比较简单的分布式应用配置管理为例来说明。

假设我们的程序是分布式部署在多台机器上，如果我们要改变程序的配置文件，需要逐台机器去修改，非常麻烦，现在把这些配置全部放到zookeeper上去，保存在 zookeeper 的某个目录节点中，然后所有相关应用程序对这个目录节点进行监听，一旦配置信息发生变化，每个应用程序就会收到 zookeeper 的通知，然后从 zookeeper 获取新的配置信息应用到系统中。



## 特点

> 1）Zookeeper：一个领导者（leader），多个跟随者（follower）组成的集群。
>
> 2）Leader负责进行投票的发起和决议，更新系统状态
>
> 3）Follower用于接收客户请求并向客户端返回结果，在选举Leader过程中参与投票
>
> 4）集群中只要有半数以上节点存活，Zookeeper集群就能正常服务。
>
> 5）全局数据一致：每个server保存一份相同的数据副本，client无论连接到哪个server，数据都是一致的。
>
> 6）更新请求顺序进行，来自同一个client的更新请求按其发送顺序依次执行。
>
> 7）数据更新原子性，一次数据更新要么成功，要么失败。
>
> 8）实时性，在一定时间范围内，client能读到最新数据。
>
> 选举机制
>
> 1）半数机制：集群中半数以上机器存活，集群可用。所以zookeeper适合装在奇数台机器上。
>
> 2）Zookeeper虽然在配置文件中并没有指定master和slave。但是，zookeeper工作时，是有一个节点为leader，其他则为follower，Leader是通过内部的选举机制临时产生的
>
> 

假设有五台服务器组成的zookeeper集群，它们的id从1-5，同时它们都是最新启动的，也就是没有历史数据，在存放数据量这一点上，都是一样的。假设这些服务器依序启动，来看看会发生什么。

（1）服务器1启动，此时只有它一台服务器启动了，它发出去的报没有任何响应，所以它的选举状态一直是LOOKING状态。

（2）服务器2启动，它与最开始启动的服务器1进行通信，互相交换自己的选举结果，由于两者都没有历史数据，所以id值较大的服务器2胜出，但是由于没有达到超过半数以上的服务器都同意选举它(这个例子中的半数以上是3)，所以服务器1、2还是继续保持LOOKING状态。

（3）服务器3启动，根据前面的理论分析，服务器3成为服务器1、2、3中的老大，而与上面不同的是，此时有三台服务器选举了它，所以它成为了这次选举的leader。

（4）服务器4启动，根据前面的分析，理论上服务器4应该是服务器1、2、3、4中最大的，但是由于前面已经有半数以上的服务器选举了服务器3，所以它只能接收当小弟的命了。

（5）服务器5启动，同4一样当小弟。

## 服务器状态

服务器具有四种状态，分别是LOOKING、FOLLOWING、LEADING、OBSERVING。

- **LOOKING**：寻找Leader状态。当服务器处于该状态时，它会认为当前集群中没有Leader，因此需要进入Leader选举状态。
- **FOLLOWING**：跟随者状态。表明当前服务器角色是Follower。
- **LEADING**：领导者状态。表明当前服务器角色是Leader。
- **OBSERVING**：观察者状态。表明当前服务器角色是Observer。

## 常用命令

- \1. 启动ZK服务:    sh bin/zkServer.sh start
- \2. 查看ZK服务状态: sh bin/zkServer.sh status
- \3. 停止ZK服务:    sh bin/zkServer.sh stop
- \4. 重启ZK服务:    sh bin/zkServer.sh restart

客户端命令：zkCli.sh -server 127.0.0.1:2181

- \1. 显示根目录下、文件： ls / 使用 ls 命令来查看当前 ZooKeeper 中所包含的内容
- \2. 显示根目录下、文件： ls2 / 查看当前节点数据并能看到更新次数等数据
- \3. 创建文件，并设置初始内容： create /zk "test" 创建一个新的 znode节点“ zk ”以及与它关联的字符串
- \4. 获取文件内容： get /zk 确认 znode 是否包含我们所创建的字符串
- \5. 修改文件内容： set /zk "zkbak" 对 zk 所关联的字符串进行设置
- \6. 删除文件： delete /zk 将刚才创建的 znode 删除
- \7. 退出客户端： quit
- \8. 帮助命令： help